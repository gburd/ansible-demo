---
- hosts: all
  become: true
  serial: 1
  pre_tasks:
    - name: Gather facts from ALL hosts (regardless of limit or tags)
      tags: always
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: True
      when: hostvars[item]['gce_private_ip'] is not defined
      with_items: "{{ groups['all'] }}"
  roles:
  - role: ansible-beats
    tags: monitoring
    beat: "metricbeat"
    beat_conf:
      "metricbeat.modules":
      - "module": "system"
        "metricsets":
          - "cpu"
          - "load"
          - "core"
          - "diskio"
          - "filesystem"
          - "fsstat"
          - "memory"
          - "network"
          - "process"
          - "socket"
        "enabled": true
        "period": "10s"
        "processes": [".*"]
        "cpu_ticks": false
      fields:
        "@tags": ["@host"]


- hosts:
    - tag_kafkas
    - tag_humios
  tags: disk
  become: true
  tasks:
    - name: parition sdb
      parted:
        device: /dev/sdb
        number: 1
        flags: [ lvm ]
        label: gpt
        state: present 
    - name: format sdb1
      filesystem:
        dev: /dev/sdb1
        fstype: xfs
    - name: mount sb1
      mount:
        fstype: xfs
        src: /dev/sdb1
        path: /var/humio
        state: mounted



- hosts: tag_zookeepers
  tags: zookeeper
  become: true
  roles:
    - role: humio.java
    - role: AnsibleShipyard.ansible-zookeeper
      zookeeper_version: 3.4.13
      zookeeper_url: "http://archive.apache.org/dist/zookeeper/zookeeper-{{ zookeeper_version }}/zookeeper-{{ zookeeper_version }}.tar.gz"
      zookeeper_hosts: "
        {%- set ips = [] %}
        {%- for host in groups['tag_zookeepers'] %}
        {{- ips.append(dict(id=hostvars[host]['ansible_local']['cluster_index'], host=host, ip=hostvars[host]['gce_private_ip'])) }}
        {%- endfor %}
        {{- ips -}}"
      # zookeeper_hosts: "
      #  {%- set ips = [] %}
      #  {%- for host in groups['zookeepers'] %}
      #  {{- ips.append(dict(id=hostvars[host]['ansible_local']['cluster_index'], host=host, ip=hostvars[host]['ansible_eth1'].ipv4.address)) }}
      #  {%- endfor %}
      #  {{- ips -}}"

- hosts: tag_kafkas
  serial: 1
  become: true
  roles:
    - role: humio.java
    - role: humio.kafka
      zookeeper_hosts: "
        {%- set ips = [] %}
        {%- for host in groups['tag_zookeepers'] %}
        {{- ips.append(dict(id=hostvars[host]['ansible_local']['cluster_index'], host=host, ip=hostvars[host]['gce_private_ip'])) }}
        {%- endfor %}
        {{- ips -}}"
      kafka_broker_id: "{{ ansible_local['cluster_index'] }}"
      kafka_listeners:
        - host: "{{ gce_private_ip }}"

- hosts: tag_humios
  serial: 1
  become: true
  roles:
    - role: "ansible-beats"
      beat: "filebeat"
      beat_conf:
        "filebeat":
          "inputs":
            - paths:
              - /var/log/syslog
              - /var/log/auth.log
              fields:
                "@type": syslog-utc
                "@tags": ["@host", "@type"]
            - paths:
              - /var/log/humio/*/humio-debug.log
              fields:
                "@type": humio
                "@tags": ["@host", "@type"]
              multiline:
                pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
                negate: true
                match: after
            - paths:
              - /var/log/kafka/server.log
              fields:
                "@type": kafka
                "@tags": ["@host", "@type"]
              multiline:
                pattern: '^\[[0-9]{4}-[0-9]{2}-[0-9]{2}'
                negate: true
                match: after
    - role: humio.java
    - role: humio.server
      tags: humio
      zookeeper_hosts: "
        {%- set ips = [] %}
        {%- for host in groups['tag_zookeepers'] %}
        {{- ips.append(dict(id=hostvars[host]['ansible_local']['cluster_index'], host=host, ip=hostvars[host]['gce_private_ip'])) }}
        {%- endfor %}
        {{- ips -}}"
      kafka_hosts: "
       {%- set ips = [] %}
       {%- for host in groups['tag_kafkas'] %}
       {{- ips.append(dict(id=hostvars[host]['ansible_local']['cluster_index'], host=host, ip=hostvars[host]['gce_private_ip'])) }}
       {%- endfor %}
       {{- ips -}}"
      humio_host_id: "{{ ansible_local['cluster_index'] }}"
      humio_config:
        "all": |
          CACHE_STORAGE_DIRECTORY=/var/humio/cache
          CACHE_STORAGE_PERCENTAGE=90
        "0": |
          EXTERNAL_URL=http://{{ gce_private_ip }}:8080
- hosts:
    - tag_kafkas
    - tag_humios
  tags: disk
  become: true
  tasks:
    - name: Check if drives are already mounted
      shell: df | grep "nvme0n1" | wc -l
      register: nvme_checked
    - name: parition nvme0n1
      when: nvme_checked.stdout  == 0
      parted:
        device: /dev/nvme0n1
        number: 1
        flags: [ lvm ]
        label: gpt
        state: present 
    - name: format nvme0n1
      when: nvme_checked.stdout  == 0
      filesystem:
        dev: /dev/nvme0n1
        fstype: xfs
    - name: mount nvme0n1
      when: nvme_checked.stdout  == 0
      mount:
        fstype: xfs
        src: /dev/nvme0n1
        path: /var/humio/cache
        state: mounted
    - name: Cache ownership
      file:
        path: /var/humio/cache
        owner: humio
        group: humio
        mode: '0755'

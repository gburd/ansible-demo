---

- hosts: localhost
  connection: local
  tasks:
    - name: Download Kafka
      get_url:
        url: http://mirrors.ae-online.de/apache/kafka/1.0.1/kafka_2.12-1.0.1.tgz
        dest: files/kafka_2.12-1.0.1.tgz
      tags: kafka
    - name: Download Humio
      get_url:
        url: "https://repo.humio.com/repository/maven-public/com/humio/server/{{ humio_version }}/server-{{ humio_version }}.jar"
        dest: "files/server-{{ humio_version }}.jar"
      tags: humio

- hosts: security_group_zookeepers
  become: true
  tags: zookeeper
  roles:
    - role: humio.java
    - role: AnsibleShipyard.ansible-zookeeper
      zookeeper_url: http://dk.mirrors.quenda.co/apache/zookeeper/zookeeper-3.4.12/zookeeper-3.4.12.tar.gz
      zookeeper_hosts: "
       {%- set ips = [] %}
       {%- for host in groups['security_group_zookeepers'] %}
       {{- ips.append(dict(id=hostvars[host]['ec2_tag_cluster_index'], host=host, ip=hostvars[host].ec2_private_ip_address)) }}
       {%- endfor %}
       {{- ips -}}"

- hosts: security_group_kafkas
  tags: kafka
  become: true
  roles:
    - role: humio.java
    - role: humio.kafka
      kafka_broker_id: "{{ ec2_tag_cluster_index }}"
      kafka_mirror: "master"
      zookeeper_hosts: "
       {%- set ips = [] %}
       {%- for host in groups['security_group_zookeepers'] %}
       {{- ips.append(dict(id=hostvars[host]['ec2_tag_cluster_index'], host=host, ip=hostvars[host].ec2_private_ip_address)) }}
       {%- endfor %}
       {{- ips -}}"
      kafka_listeners:
        - host: "{{ ec2_private_ip_address }}"

- hosts: security_group_humios
  tags: humio
  become: true
  serial: 1
  roles:
    - role: humio.java
    - role: humio.server
      zookeeper_hosts: "
       {%- set ips = [] %}
       {%- for host in groups['security_group_zookeepers'] %}
       {{- ips.append(dict(id=hostvars[host]['ec2_tag_cluster_index'], host=host, ip=hostvars[host].ec2_private_ip_address)) }}
       {%- endfor %}
       {{- ips -}}"
      kafka_hosts: "
       {%- set ips = [] %}
       {%- for host in groups['security_group_kafkas'] %}
       {{- ips.append(dict(id=hostvars[host]['ec2_tag_cluster_index'], host=host, ip=hostvars[host].ec2_private_ip_address)) }}
       {%- endfor %}
       {{- ips -}}"
      humio_mirror: "master"
      humio_config:
##        all: "FILE=humio_config"
        "0": "EXTERNAL_URL=http://{{ ec2_private_ip_address }}:8080"

- hosts: localhost
  connection: local
  tags: humio
  tasks:
  - name: Rebalance partitions
    tags: humio
    uri:
      url: http://{{ hostvars[groups['security_group_humios']|random].ec2_public_dns_name }}:8080/api/v1/clusterconfig/partitions/setdefaults
      method: POST
  - debug:
      msg: "Congratulations. Humio is now available at http://{{ hostvars[groups['security_group_humios']|random].ec2_public_dns_name }}:8080/"
